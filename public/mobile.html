<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2196F3">
    <title>üè†‚Äç‚¨õ Raven</title>
    <script src="/socket.io/socket.io.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --app-bg: #ffffff;
            --header-bg: #2196F3;
            --header-text: #ffffff;
            --status-bg: #f5f5f5;
            --status-text: #666666;
            --message-bg: #fafafa;
            --message-my-bg: #2196F3;
            --message-my-text: #ffffff;
            --message-other-bg: #ffffff;
            --message-other-text: #333333;
            --message-border: #e0e0e0;
            --input-bg: #ffffff;
            --input-text: #333333;
            --input-border: #e0e0e0;
            --button-bg: #2196F3;
            --button-hover: #1976D2;
            --voice-btn-bg: #4CAF50;
            --voice-btn-hover: #45a049;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --app-bg: #0f3460;
            --header-bg: #16213e;
            --header-text: #e94560;
            --status-bg: #1a1a2e;
            --status-text: #a0a0a0;
            --message-bg: #16213e;
            --message-my-bg: #e94560;
            --message-my-text: #ffffff;
            --message-other-bg: #1a1a2e;
            --message-other-text: #ffffff;
            --message-border: #2d3561;
            --input-bg: #1a1a2e;
            --input-text: #ffffff;
            --input-border: #2d3561;
            --button-bg: #e94560;
            --button-hover: #c23550;
            --voice-btn-bg: #00d9ff;
            --voice-btn-hover: #00b8d4;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 0;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        html {
            height: -webkit-fill-available;
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: var(--app-bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .header-content {
            flex: 1;
            text-align: center;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--header-text);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .status {
            background: var(--status-bg);
            padding: 10px 20px;
            text-align: center;
            color: var(--status-text);
            border-bottom: 1px solid var(--message-border);
            transition: all 0.3s ease;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--message-bg);
            transition: all 0.3s ease;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }

        .message.my {
            background: var(--message-my-bg);
            color: var(--message-my-text);
            margin-left: auto;
            text-align: right;
        }

        .message.other {
            background: var(--message-other-bg);
            color: var(--message-other-text);
            border: 1px solid var(--message-border);
        }

        .message-username {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .message-text {
            font-size: 16px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.7;
        }

        .input-container {
            padding: 20px;
            background: var(--input-bg);
            border-top: 1px solid var(--input-border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .emoji-panel {
            background: var(--input-bg);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid var(--input-border);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .emoji-button {
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            user-select: none;
        }

        .emoji-button:hover {
            background: #e0e0e0;
            transform: scale(1.2);
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .emoji-toggle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--input-border);
            background: var(--input-bg);
            color: var(--input-text);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-toggle:hover {
            background: var(--status-bg);
            border-color: var(--button-bg);
            transform: scale(1.05);
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--input-border);
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
            background: var(--input-bg);
            color: var(--input-text);
        }

        .input-field:focus {
            border-color: var(--button-bg);
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--button-bg);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: var(--button-hover);
        }

        .send-button:disabled {
            background: #888;
            cursor: not-allowed;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
        .voice-button {
            background: var(--voice-btn-bg);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-button:hover {
            background: var(--voice-btn-hover);
            transform: scale(1.1);
        }

        .voice-button.recording {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .voice-recording-panel {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideDown 0.3s ease-out;
        }

        .voice-timer {
            font-weight: bold;
            color: #856404;
            font-size: 18px;
        }

        .voice-controls {
            display: flex;
            gap: 10px;
        }

        .voice-control-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .voice-send-btn {
            background: #28a745;
            color: white;
        }

        .voice-cancel-btn {
            background: #dc3545;
            color: white;
        }

        .voice-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .voice-message {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 15px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .voice-player {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .voice-play-btn {
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .voice-play-btn:hover {
            background: #1976D2;
            transform: scale(1.1);
        }

        .voice-duration {
            font-size: 12px;
            color: #666;
            min-width: 40px;
        }

        .voice-waveform {
            flex: 1;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .voice-progress {
            height: 100%;
            background: linear-gradient(90deg, #2196F3, #21CBF3);
            border-radius: 15px;
            transition: width 0.1s;
        }

        .login-container {
            max-width: 400px;
            padding: 40px;
            text-align: center;
        }

        .login-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #868686;
            border-radius: 25px;
            font-size: 18px;
            text-align: center;
            margin: 20px 0;
            outline: none;
        }

        .login-button {
            width: 100%;
            padding: 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-button:hover {
            background: #1976D2;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
                align-items: stretch;
            }

            .app-container {
                height: 100vh;
                height: -webkit-fill-available;
                max-width: 100%;
                border-radius: 0;
                margin: 0;
                max-height: 100vh;
                max-height: -webkit-fill-available;
            }

            .header {
                padding: 15px;
                padding-top: max(15px, env(safe-area-inset-top));
            }

            .header h1 {
                font-size: 20px;
            }

            .messages-container {
                padding: 10px;
                padding-bottom: 5px;
            }

            .message {
                max-width: 80%;
                font-size: 15px;
            }

            .input-container {
                padding: 10px;
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }

            .input-row {
                gap: 8px;
            }

            .emoji-toggle, .voice-button, .send-button {
                width: 45px;
                height: 45px;
                font-size: 18px;
                flex-shrink: 0;
            }

            .input-field {
                font-size: 16px;
            }

            .emoji-panel {
                max-height: 120px;
            }

            .voice-play-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            .theme-toggle {
                padding: 6px 10px;
                font-size: 18px;
            }
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 18px;
            }

            .emoji-toggle, .voice-button, .send-button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .input-field {
                font-size: 14px;
                padding: 10px 14px;
            }

            .message {
                max-width: 85%;
                font-size: 14px;
            }
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (min-width: 769px) and (max-width: 1024px) {
            .app-container {
                max-width: 90%;
                height: 85vh;
            }
        }

        /* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-height: 500px) and (orientation: landscape) {
            .app-container {
                height: 100vh;
            }

            .header {
                padding: 10px 15px;
            }

            .messages-container {
                padding: 8px;
            }

            .input-container {
                padding: 8px;
            }

            .emoji-panel {
                max-height: 80px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏ */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 20px;
            margin: 5px 0;
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        .typing-dots {
            margin-right: 10px;
        }

        .typing-animation {
            display: flex;
            gap: 3px;
        }

        .typing-animation span {
            width: 6px;
            height: 6px;
            background: #2196F3;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-animation span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-animation span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingBounce {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [currentUser, setCurrentUser] = useState('');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [messages, setMessages] = useState([]);
            const [messageText, setMessageText] = useState('');
            const [userCount, setUserCount] = useState(0);
            const [isConnected, setIsConnected] = useState(false);
            const [typingUsers, setTypingUsers] = useState([]);
            const [showEmojiPanel, setShowEmojiPanel] = useState(false);
            const [isDarkTheme, setIsDarkTheme] = useState(false);
            
            // State –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            const [mediaRecorder, setMediaRecorder] = useState(null);
            const [audioChunks, setAudioChunks] = useState([]);
            const [playingAudio, setPlayingAudio] = useState(null);

            const socketRef = useRef(null);
            const messagesEndRef = useRef(null);
            const typingTimeoutRef = useRef(null);
            const recordingIntervalRef = useRef(null);

            // –°–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —ç–º–æ–¥–∑–∏
            const emojis = ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'üò§', 'üò†', 'üò°', 'ü§¨', 'üò±', 'üò®', 'üò∞', 'üò•', 'üò¢', 'ü§î', 'ü§ó', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'üëç', 'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', '‚úã', 'ü§ö', 'üñêÔ∏è', 'üññ', 'üëã', 'ü§è', 'üí™', 'ü¶æ', 'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üíÉ', 'üï∫', 'üëØ', 'üßó', 'üèá', '‚õ∑Ô∏è', 'üèÇ', 'üèåÔ∏è', 'üèÑ', 'üö£', 'üèä', '‚õπÔ∏è', 'üèãÔ∏è', 'üö¥', 'üöµ', 'ü§∏', 'ü§º', 'ü§Ω', 'ü§æ', 'ü§π', 'üßò', 'üõÄ', 'üõå', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', 'üî•', '‚ú®', 'üí´', '‚≠ê', 'üåü', 'üí•', 'üíØ', 'üí¢', 'üí®', 'üí§', 'üï≥Ô∏è', 'üéâ', 'üéä', 'üôà', 'üôâ', 'üôä', 'üíØ', 'üí´', '‚ö°', 'üî•', 'üíù', 'üéÅ', 'üéà', 'üéÄ', 'üéä', 'üéâ'];

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const playNotificationSound = () => {
                try {
                    // –°–æ–∑–¥–∞–µ–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é Web Audio API
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (error) {
                    console.log('–ó–≤—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
                }
            };

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
            useEffect(() => {
                const savedTheme = localStorage.getItem('darkTheme') === 'true';
                setIsDarkTheme(savedTheme);
                document.documentElement.setAttribute('data-theme', savedTheme ? 'dark' : 'light');
            }, []);

            // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
            const toggleTheme = () => {
                const newTheme = !isDarkTheme;
                setIsDarkTheme(newTheme);
                document.documentElement.setAttribute('data-theme', newTheme ? 'dark' : 'light');
                localStorage.setItem('darkTheme', newTheme);
            };

            useEffect(() => {
                // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
                socketRef.current = io();

                socketRef.current.on('connect', () => {
                    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É');
                    setIsConnected(true);
                });

                socketRef.current.on('disconnect', () => {
                    console.log('–û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    setIsConnected(false);
                });

                socketRef.current.on('messageHistory', (history) => {
                    setMessages(history);
                });

                socketRef.current.on('newMessage', (message) => {
                    console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                    setMessages(prev => [...prev, message]);
                    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (message.username !== currentUser) {
                        playNotificationSound();
                    }
                });

                socketRef.current.on('userJoined', (data) => {
                    setUserCount(data.userCount);
                });

                socketRef.current.on('userLeft', (data) => {
                    setUserCount(data.userCount);
                });

                socketRef.current.on('userTyping', (data) => {
                    setTypingUsers(prev => {
                        if (!prev.includes(data.username) && data.username !== currentUser) {
                            return [...prev, data.username];
                        }
                        return prev;
                    });
                });

                socketRef.current.on('userStoppedTyping', (data) => {
                    setTypingUsers(prev => prev.filter(user => user !== data.username));
                });

                socketRef.current.on('joinSuccess', (data) => {
                    setUserCount(data.userCount);
                });

                return () => {
                    if (socketRef.current) {
                        socketRef.current.disconnect();
                    }
                };
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const handleLogin = (username) => {
                if (username.trim()) {
                    setCurrentUser(username.trim());
                    setIsLoggedIn(true);
                    socketRef.current.emit('userJoin', username.trim());
                }
            };

            const sendMessage = () => {
                if (messageText.trim() && isConnected) {
                    const currentTime = new Date().toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    socketRef.current.emit('sendMessage', {
                        username: currentUser,
                        text: messageText.trim(),
                        time: currentTime
                    });
                    setMessageText('');
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    socketRef.current.emit('stopTyping', { username: currentUser });
                }
            };

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            const startRecording = async () => {
                try {
                    console.log('üéôÔ∏è –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å...');
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const recorder = new MediaRecorder(stream);
                    console.log('‚úÖ MediaRecorder —Å–æ–∑–¥–∞–Ω');
                    
                    setMediaRecorder(recorder);
                    setAudioChunks([]);
                    setIsRecording(true);
                    setRecordingTime(0);

                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                    recordingIntervalRef.current = setInterval(() => {
                        setRecordingTime(prev => prev + 1);
                    }, 1000);

                    recorder.ondataavailable = (event) => {
                        console.log('üìä –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', event.data.size, 'bytes');
                        if (event.data.size > 0) {
                            setAudioChunks(prev => {
                                const newChunks = [...prev, event.data];
                                console.log('üíæ –í—Å–µ–≥–æ chunks:', newChunks.length);
                                return newChunks;
                            });
                        }
                    };

                    recorder.start();
                    console.log('‚ñ∂Ô∏è –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                }
            };

            const sendVoiceMessage = async (audioBlob) => {
                try {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∞—É–¥–∏–æ –≤ base64
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const audioData = reader.result;
                        const currentTime = new Date().toLocaleTimeString('ru-RU', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Socket.io —Å base64 –¥–∞–Ω–Ω—ã–º–∏
                        const voiceMessage = {
                            username: currentUser,
                            text: 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                            audioData: audioData, // base64 –∞—É–¥–∏–æ
                            duration: formatTime(recordingTime), // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏
                            time: currentTime,
                            type: 'voice'
                        };
                        console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –≥–æ–ª–æ—Å–æ–≤–æ–µ:', {
                            type: voiceMessage.type,
                            hasAudioData: !!voiceMessage.audioData,
                            audioDataLength: voiceMessage.audioData?.length,
                            duration: voiceMessage.duration
                        });
                        socketRef.current.emit('sendMessage', voiceMessage);
                    };
                    reader.readAsDataURL(audioBlob);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
                }
            };

            const handleVoiceSend = () => {
                if (audioChunks.length > 0) {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    sendVoiceMessage(audioBlob);
                    setAudioChunks([]);
                    setRecordingTime(0);
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
                    stopRecording();
                }
            };

            const stopRecording = () => {
                console.log('üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å...');
                if (mediaRecorder && isRecording) {
                    // –°–æ–∑–¥–∞—ë–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è chunks
                    let recordedChunks = [];
                    
                    mediaRecorder.onstop = () => {
                        console.log('‚èπÔ∏è –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, chunks:', recordedChunks.length);
                        
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∏
                        if (mediaRecorder.stream) {
                            mediaRecorder.stream.getTracks().forEach(track => track.stop());
                        }
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
                        if (recordedChunks.length > 0) {
                            console.log('üì§ –°–æ–∑–¥–∞—ë–º blob –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º...');
                            const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                            sendVoiceMessage(audioBlob);
                        } else {
                            console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏!');
                        }
                        
                        setAudioChunks([]);
                        setRecordingTime(0);
                    };
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ chunks –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
                    setAudioChunks(prev => {
                        recordedChunks = [...prev];
                        console.log('üíæ –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ chunks:', recordedChunks.length);
                        return prev;
                    });
                    
                    mediaRecorder.stop();
                    setIsRecording(false);
                    clearInterval(recordingIntervalRef.current);
                }
            };

            const handleVoiceCancel = () => {
                setAudioChunks([]);
                setRecordingTime(0);
                setIsRecording(false);
                clearInterval(recordingIntervalRef.current);
                
                if (mediaRecorder) {
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
            };

            const playVoiceMessage = (audioUrl) => {
                try {
                    if (playingAudio) {
                        playingAudio.pause();
                        setPlayingAudio(null);
                        return;
                    }

                    const audio = new Audio(audioUrl);
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
                    audio.onerror = (e) => {
                        console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                        setPlayingAudio(null);
                    };

                    audio.onended = () => {
                        setPlayingAudio(null);
                    };

                    audio.play().catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:', err);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ');
                    });
                    
                    setPlayingAudio(audio);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ playVoiceMessage:', error);
                    alert('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const handleInputChange = (e) => {
                setMessageText(e.target.value);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –Ω–∞—á–∞–ª–∞ –ø–µ—á–∞—Ç–∏
                if (e.target.value.trim() && isConnected) {
                    socketRef.current.emit('typing', { username: currentUser });

                    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
                    if (typingTimeoutRef.current) {
                        clearTimeout(typingTimeoutRef.current);
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—á–∞—Ç–∏
                    typingTimeoutRef.current = setTimeout(() => {
                        socketRef.current.emit('stopTyping', { username: currentUser });
                    }, 1000); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è
                } else {
                    // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—á–∞—Ç—å
                    socketRef.current.emit('stopTyping', { username: currentUser });
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    if (isLoggedIn) {
                        sendMessage();
                    } else {
                        handleLogin(e.target.value);
                    }
                }
            };

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç–º–æ–¥–∑–∏
            const toggleEmojiPanel = () => {
                setShowEmojiPanel(!showEmojiPanel);
            };

            const addEmoji = (emoji) => {
                setMessageText(prev => prev + emoji);
                setShowEmojiPanel(false); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
            };

            if (!isLoggedIn) {
                return (
                    <div className="app-container">
                        <div className="login-container">
                            <h1>ÔøΩ‚Äç‚¨õ Raven</h1>
                            <p style={{color: '#666', margin: '20px 0'}}>
                                –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —á–∞—Ç
                            </p>
                            <input
                                type="text"
                                placeholder="–í–∞—à–µ –∏–º—è..."
                                className="login-input"
                                onKeyPress={handleKeyPress}
                                maxLength={20}
                            />
                            <div style={{fontSize: '14px', color: '#999'}}>
                                {isConnected ? 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É' : 'üî¥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="app-container">
                    <div className="header">
                        <div className="header-content">
                            <h1>üè†‚Äç‚¨õ Raven</h1>
                            <div>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {currentUser}!</div>
                        </div>
                        <button className="theme-toggle" onClick={toggleTheme} title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                            {isDarkTheme ? '‚òÄÔ∏è' : 'üåô'}
                        </button>
                    </div>
                    
                    <div className="status">
                        {isConnected ? `üü¢ –û–Ω–ª–∞–π–Ω ‚Ä¢ ${userCount} —á–µ–ª–æ–≤–µ–∫` : 'üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...'}
                    </div>

                    <div className="messages-container">
                        {messages.map((message) => {
                            console.log('üé® –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏—è:', {
                                id: message.id,
                                type: message.type,
                                hasAudioData: !!message.audioData,
                                hasAudioUrl: !!message.audioUrl,
                                text: message.text
                            });
                            return (
                            <div
                                key={message.id}
                                className={`message ${message.username === currentUser ? 'my' : 'other'}`}
                            >
                                {message.username !== currentUser && (
                                    <div className="message-username">{message.username}</div>
                                )}
                                
                                {/* –û–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                                {message.type !== 'voice' && !message.audioData && !message.audioUrl && (
                                    <div className="message-text">{message.text}</div>
                                )}
                                
                                {/* –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å audioData/audioUrl –ò–õ–ò type=voice */}
                                {((message.type === 'voice') || message.audioData || message.audioUrl) && (
                                    <div className="voice-message">
                                        <div className="voice-player">
                                            <button 
                                                className="voice-play-btn"
                                                onClick={() => playVoiceMessage(message.audioData || message.audioUrl)}
                                                title={playingAudio ? "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" : "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏"}
                                            >
                                                {playingAudio ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                                            </button>
                                            <div className="voice-waveform">
                                                <div className="voice-progress" style={{width: playingAudio ? '100%' : '0%'}}></div>
                                            </div>
                                            <span className="voice-duration">üé§ {message.duration || message.text || '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}</span>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="message-time">{message.time}</div>
                            </div>
                            );
                        })}
                        
                        {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ */}
                        {typingUsers.length > 0 && (
                            <div className="typing-indicator">
                                <span className="typing-dots">
                                    {typingUsers.length === 1 
                                        ? `${typingUsers[0]} –ø–µ—á–∞—Ç–∞–µ—Ç...` 
                                        : `${typingUsers.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–µ—á–∞—Ç–∞—é—Ç...`
                                    }
                                </span>
                                <div className="typing-animation">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        )}
                        
                        <div ref={messagesEndRef} />
                    </div>

                    <div className="input-container">
                        {/* –ü–∞–Ω–µ–ª—å –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */}
                        {isRecording && (
                            <div className="voice-recording-panel">
                                <span>üé§ –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...</span>
                                <span className="voice-timer">{formatTime(recordingTime)}</span>
                                <div className="voice-controls">
                                    <button 
                                        className="voice-control-btn voice-send-btn"
                                        onClick={handleVoiceSend}
                                    >
                                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                    </button>
                                    <button 
                                        className="voice-control-btn voice-cancel-btn"
                                        onClick={handleVoiceCancel}
                                    >
                                        –û—Ç–º–µ–Ω–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* –ü–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏ */}
                        {showEmojiPanel && (
                            <div className="emoji-panel">
                                {emojis.map((emoji, index) => (
                                    <span 
                                        key={index}
                                        className="emoji-button"
                                        onClick={() => addEmoji(emoji)}
                                    >
                                        {emoji}
                                    </span>
                                ))}
                            </div>
                        )}
                        
                        {/* –°—Ç—Ä–æ–∫–∞ –≤–≤–æ–¥–∞ */}
                        <div className="input-row">
                            <button 
                                className="emoji-toggle"
                                onClick={toggleEmojiPanel}
                                title="–î–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏"
                            >
                                üòÄ
                            </button>
                            <input
                                type="text"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                                value={messageText}
                                onChange={handleInputChange}
                                onKeyPress={handleKeyPress}
                                className="input-field"
                                maxLength={500}
                            />
                            <button
                                className={`voice-button ${isRecording ? 'recording' : ''}`}
                                onClick={isRecording ? stopRecording : startRecording}
                                title={isRecording ? "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å" : "–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"}
                            >
                                üé§
                            </button>
                            <button
                                onClick={sendMessage}
                                disabled={!messageText.trim() || !isConnected}
                                className="send-button"
                            >
                                ‚û§
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>