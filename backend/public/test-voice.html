<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
        }
        #log {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            font-family: monospace;
            font-size: 12px;
        }
        .recording {
            background: red;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üé§ –¢–µ—Å—Ç –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</h1>
    
    <button id="recordBtn">üéôÔ∏è –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <button id="playBtn" disabled>‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
    <button id="sendBtn" disabled>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
    <button id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    
    <h3>–õ–æ–≥:</h3>
    <div id="log"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let isRecording = false;
        
        const recordBtn = document.getElementById('recordBtn');
        const playBtn = document.getElementById('playBtn');
        const sendBtn = document.getElementById('sendBtn');
        const clearBtn = document.getElementById('clearBtn');
        const logDiv = document.getElementById('log');
        
        function log(message) {
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        recordBtn.onclick = async () => {
            if (!isRecording) {
                try {
                    log('üéôÔ∏è –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    log('‚úÖ –î–æ—Å—Ç—É–ø –ø–æ–ª—É—á–µ–Ω');
                    
                    const options = {
                        mimeType: 'audio/webm;codecs=opus',
                        audioBitsPerSecond: 16000
                    };
                    
                    mediaRecorder = new MediaRecorder(stream, options);
                    log(`‚úÖ MediaRecorder —Å–æ–∑–¥–∞–Ω: ${mediaRecorder.mimeType}`);
                    
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                            log(`üìä –ü–æ–ª—É—á–µ–Ω chunk: ${event.data.size} bytes`);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        log('‚èπÔ∏è –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        log(`üíæ –°–æ–∑–¥–∞–Ω blob: ${audioBlob.size} bytes`);
                        playBtn.disabled = false;
                        sendBtn.disabled = false;
                        
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–µ–∫–∏
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                    recordBtn.classList.add('recording');
                    log('‚ñ∂Ô∏è –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
                    
                } catch (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.textContent = 'üéôÔ∏è –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
                recordBtn.classList.remove('recording');
            }
        };
        
        playBtn.onclick = () => {
            if (audioBlob) {
                log('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...');
                const url = URL.createObjectURL(audioBlob);
                const audio = new Audio(url);
                audio.play();
                audio.onended = () => log('‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
            }
        };
        
        sendBtn.onclick = async () => {
            if (!audioBlob) return;
            
            log('üì§ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64...');
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64 = reader.result;
                log(`‚úÖ Base64 —Å–æ–∑–¥–∞–Ω: ${base64.length} —Å–∏–º–≤–æ–ª–æ–≤`);
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Socket.io
                const socket = io();
                
                socket.on('connect', () => {
                    log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                    
                    const message = {
                        username: '–¢–µ—Å—Ç–µ—Ä',
                        text: 'üé§ –¢–µ—Å—Ç–æ–≤–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ',
                        audioData: base64,
                        type: 'voice',
                        duration: '0:05',
                        time: new Date().toLocaleTimeString('ru-RU', {
                            hour: '2-digit',
                            minute: '2-digit'
                        })
                    };
                    
                    log('üì® –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
                    socket.emit('sendMessage', message);
                    log('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                });
                
                socket.on('newMessage', (msg) => {
                    log(`üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${msg.username} - —Ç–∏–ø: ${msg.type}`);
                });
                
                socket.on('error', (error) => {
                    log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}`);
                });
            };
            reader.readAsDataURL(audioBlob);
        };
        
        clearBtn.onclick = () => {
            logDiv.innerHTML = '';
        };
        
        log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
    </script>
</body>
</html>
